const express = require('express');
const cors = require('cors');
const cloudinary = require('./cloudinary');
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const bcrypt = require('bcrypt');
const db = require('./db'); // db ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô connection object

const { CloudinaryStorage } = require('multer-storage-cloudinary');

const app = express();
const compression = require('compression');
app.use(compression());

const PORT = 3001;

const allowedOrigins = [
  'http://localhost:5173',        // Dev React
  'http://127.0.0.1:5173',        // Dev React ‡∏≠‡∏µ‡∏Å‡πÅ‡∏ö‡∏ö
  'https://employee01.onrender.com' // Prod React ‡∏ö‡∏ô Render
];

// Middleware CORS
app.use(cors({
  origin: function (origin, callback) {
    // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï request ‡∏à‡∏≤‡∏Å Postman ‡∏´‡∏£‡∏∑‡∏≠ server ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
    if (!origin) return callback(null, true);

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô dev ‡πÉ‡∏´‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∏‡∏Å origin
    if (process.env.NODE_ENV === 'development') {
      return callback(null, true);
    }

    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô allowedOrigins
    if (allowedOrigins.includes(origin)) {
      return callback(null, true);
    } else {
      return callback(new Error('Not allowed by CORS: ' + origin));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'HEAD'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

// ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö preflight requests
app.options('*', cors());



//app.use('/uploads', express.static(path.join(__dirname, 'uploads')))
// Middleware


app.use(express.json());

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå uploads ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
const uploadDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir);
}

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ multer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå
const storage = new CloudinaryStorage({
  cloudinary: cloudinary,
  params: {
    folder: 'employee_profile_images', // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ö‡∏ô Cloudinary
    allowed_formats: ['jpg', 'png', 'jpeg'],
    public_id: (req, file) => Date.now() + '-' + file.originalname
  }
});

const upload = multer({ storage });

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á employee_id ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
function generateEmployeeId() {
  return 'EMP' + Date.now().toString().slice(-6);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
function formatDate(dateStr) {
  if (!dateStr) return null;
  const d = new Date(dateStr);
  return d.toISOString().split('T')[0];
}

// --- API ---

// Login
app.post('/api/login', (req, res) => {
  const { username, password } = req.body;

  console.log('üîç Login payload:', username, password); // log ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤

  const sql = 'SELECT * FROM users WHERE username = ?';
  db.query(sql, [username], async (err, results) => {
    if (err) {
      console.error('‚ùå Database error:', err);
      return res.status(500).json({ message: 'Database error' });
    }

    console.log('üîç Query result:', results); // log ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å query

    if (results.length === 0) {
      return res.status(401).json({ message: 'Invalid username or password' });
    }

    const user = results[0];

    const match = await bcrypt.compare(password, user.password);
    if (!match) {
      return res.status(401).json({ message: 'Invalid username or password' });
    }

    res.json({
      user_id: user.user_id,
      username: user.username,
      full_name: user.full_name,
      role: user.role
    });
  });
});

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function formatDateToYMD(date) {
  if (!date) return null;
  const d = new Date(date);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

app.get('/api/employees', (req, res) => {
  const sql = 'SELECT * FROM employee';
  db.query(sql, (err, results) => {
    if (err) {
      console.error('Error fetching employees:', err);
      return res.status(500).json({ message: 'Database error' });
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô yyyy-mm-dd
    const formattedResults = results.map(emp => ({
      ...emp,
      birth_date: formatDateToYMD(emp.birth_date),
      start_date: formatDateToYMD(emp.start_date),
      resign_date: formatDateToYMD(emp.resign_date),
    }));

    res.json(formattedResults);
  });
});

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠
app.get('/api/employees/search', (req, res) => {
  const { name } = req.query;
  const sql = `SELECT * FROM employee WHERE full_name LIKE ?`;
  db.query(sql, [`%${name}%`], (err, results) => {
    if (err) return res.status(500).json(err);

    const formattedResults = results.map(emp => ({
      ...emp,
      birth_date: formatDateToYMD(emp.birth_date),
      start_date: formatDateToYMD(emp.start_date),
      resign_date: formatDateToYMD(emp.resign_date),
    }));

    res.json(formattedResults);
  });
});

app.post('/api/employees', upload.single('profile_image'), async (req, res) => {
  try {
    const {
      employee_id,
      full_name,
      gender,
      age,
      birth_date,
      citizen_id,
      start_date,
      bank_account,
      current_salary,
      department,
      position,
      Google_drive
    } = req.body;

    let profileImage = null;

    if (req.file && req.file.path) {
  profileImage = req.file.path;
}

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏µ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    const formattedStartDate = start_date ? new Date(start_date) : null;
    const formattedNow = new Date();
    let years_of_service = 0;
    if (formattedStartDate) {
      years_of_service = formattedNow.getFullYear() - formattedStartDate.getFullYear();
      const hasNotCompletedYear =
        formattedNow.getMonth() < formattedStartDate.getMonth() ||
        (formattedNow.getMonth() === formattedStartDate.getMonth() &&
          formattedNow.getDate() < formattedStartDate.getDate());
      if (hasNotCompletedYear) {
        years_of_service -= 1;
      }
    }

    const sql = `
      INSERT INTO employee (
        employee_id, full_name, gender, age, birth_date, citizen_id,
        start_date, years_of_service, bank_account, current_salary, department, profile_image, position, Google_drive
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;

    const values = [
      employee_id,
      full_name,
      gender,
      age ? parseInt(age) : 0,
      birth_date || null,
      citizen_id,
      start_date || null,
      years_of_service,
      bank_account || null,
      current_salary ? parseFloat(current_salary) : 0,
      department,
      profileImage,  // <-- ‡πÄ‡∏≠‡∏≤ URL ‡∏à‡∏≤‡∏Å Cloudinary
      position,
      Google_drive
    ];

    db.query(sql, values, (err, result) => {
      if (err) {
        console.error('Insert error:', err);
        return res.status(500).json({ error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' });
      }
      res.json({ message: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', employee_id, profile_image: profileImage });
    });
  } catch (error) {
    console.error('Upload error:', error);
    res.status(500).json({ error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û', details: error.message });
  }
});

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô

app.put('/api/EDemployees/:id', upload.single('profile_image'), async (req, res) => {
  const employeeId = req.params.id;
  const {
    full_name,
    gender,
    age,
    birth_date,
    citizen_id,
    start_date,
    resign_date,
    bank_account,
    current_salary,
    department,
    position,
    Google_drive,
    user_id
  } = req.body;

  function formatDate(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (isNaN(d)) return null;
    const offsetMs = d.getTimezoneOffset() * 60 * 1000;
    const correctedDate = new Date(d.getTime() - offsetMs);
    return correctedDate.toISOString().slice(0, 10);
  }

  function formatDateOnly(date) {
    if (!date) return '';
    const d = new Date(date);
    if (isNaN(d)) return '';
    const offsetMs = d.getTimezoneOffset() * 60 * 1000;
    const correctedDate = new Date(d.getTime() - offsetMs);
    return correctedDate.toISOString().slice(0, 10);
  }

  const formatted_birth_date = formatDate(birth_date);
  const formatted_start_date = formatDate(start_date);
  const formatted_resign_date = resign_date ? formatDate(resign_date) : null;

  const sqlSelect = 'SELECT * FROM employee WHERE employee_id = ?';
  db.query(sqlSelect, [employeeId], async (err, results) => {
    if (err) return res.status(500).json({ error: 'Database error' });
    if (results.length === 0) return res.status(404).json({ error: 'Employee not found' });

    const oldData = results[0];
    const years_of_service = formatted_resign_date
      ? new Date(formatted_resign_date).getFullYear() - new Date(formatted_start_date).getFullYear()
      : new Date().getFullYear() - new Date(formatted_start_date).getFullYear();

    let profile_image = oldData.profile_image;

    if (req.file && req.file.path) {
  profile_image = req.file.path; // path ‡∏ó‡∏µ‡πà cloudinary storage ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô URL ‡πÅ‡∏•‡πâ‡∏ß
}


    const newData = {
      full_name,
      gender,
      age: parseInt(age),
      birth_date: formatted_birth_date,
      citizen_id,
      start_date: formatted_start_date,
      resign_date: formatted_resign_date,
      years_of_service,
      bank_account,
      current_salary: parseFloat(current_salary),
      department,
      position,
      Google_drive,
      profile_image
    };

    const changedFields = {};
    for (const key in newData) {
      let oldVal = oldData[key];
      let newVal = newData[key];
      if (['birth_date', 'start_date', 'resign_date'].includes(key)) {
        oldVal = formatDateOnly(oldVal);
        newVal = formatDateOnly(newVal);
      } else {
        oldVal = oldVal === null ? '' : String(oldVal);
        newVal = newVal === null ? '' : String(newVal);
      }
      if (oldVal !== newVal) {
        changedFields[key] = { before: oldVal, after: newVal };
      }
    }

    if (Object.keys(changedFields).length === 0) {
      return res.json({ message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' });
    }

    const sqlUpdate = `
      UPDATE employee SET
        full_name = ?, gender = ?, age = ?, birth_date = ?, citizen_id = ?,
        start_date = ?, resign_date = ?, years_of_service = ?, bank_account = ?,
        current_salary = ?, department = ?, position = ?, Google_drive = ?, profile_image = ?
      WHERE employee_id = ?
    `;
    const updateValues = [
      full_name, gender, parseInt(age), formatted_birth_date, citizen_id,
      formatted_start_date, formatted_resign_date, years_of_service, bank_account,
      parseFloat(current_salary), department, position, Google_drive, profile_image, employeeId
    ];

    db.query(sqlUpdate, updateValues, (updateErr) => {
      if (updateErr) return res.status(500).json({ error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' });

      const logSql = `
        INSERT INTO log_edemployee (user_id, action, target_table, target_id, description, created_at)
        VALUES (?, ?, ?, ?, ?, NOW())
      `;
      const logValues = [
        user_id || 0, 'Edit Employee', 'employee', employeeId, JSON.stringify(changedFields)
      ];

      db.query(logSql, logValues, (logErr) => {
        if (logErr) console.error('‚ùå Error logging:', logErr);
        return res.json({
          message: '‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          profile_image: profile_image // ‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Cloudinary
        });
      });
    });
  });
});







// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á API ‡∏î‡∏∂‡∏á log ‡∏û‡∏£‡πâ‡∏≠‡∏° username ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á users
app.get('/api/logs/employee-edit', (req, res) => {
  const sqlLogs = `
    SELECT
      log.log_id,
      log.user_id,
      u.username AS editor_username,
      log.action,
      log.target_table,
      log.target_id,
      e.full_name AS edited_employee_name,
      log.description,
      log.created_at
    FROM log_edemployee log
    LEFT JOIN users u ON log.user_id = u.user_id
    LEFT JOIN employee e ON log.target_id = e.employee_id
    ORDER BY log.created_at DESC
    LIMIT 100
  `;

  db.query(sqlLogs, (err, logs) => {
    if (err) {
      console.error('‚ùå Database error:', err);
      return res.status(500).json({ error: 'Database error' });
    }

    const parsedLogs = logs.map(log => {
      let descriptionParsed;

      try {
        descriptionParsed = log.description ? JSON.parse(log.description) : null;
      } catch (e) {
        descriptionParsed = log.description || null;
      }

      return {
        ...log,
        description: descriptionParsed
      };
    });

    res.json(parsedLogs);
  });
});




// ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
app.post('/register', async (req, res) => {
  const { username, password, full_name, role } = req.body;

  if (!username || !password || !full_name || !role) {
    return res.status(400).json({ message: 'Missing required fields' });
  }

  const saltRounds = 10; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const checkSql = 'SELECT * FROM users WHERE username = ?';
    db.query(checkSql, [username], async (err, results) => {
      if (err) return res.status(500).json({ message: 'Database error' });
      if (results.length > 0) {
        return res.status(409).json({ message: 'Username already exists' });
      }

      // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      const hashedPassword = await bcrypt.hash(password, saltRounds);
      const createdAt = new Date(); // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á

      const insertSql = `
        INSERT INTO users (username, password, full_name, role, created_at)
        VALUES (?, ?, ?, ?, ?)
      `;
      db.query(insertSql, [username, hashedPassword, full_name, role, createdAt], (err, result) => {
        if (err) return res.status(500).json({ message: 'Insert failed', error: err });

        res.status(201).json({ message: 'User registered successfully', user_id: result.insertId });
      });
    });
  } catch (err) {
    res.status(500).json({ message: 'Server error', error: err });
  }
});



const distPath = path.join(__dirname, 'employee-dist');

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ index.html ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
const indexPath = path.join(distPath, 'index.html');
const indexExists = fs.existsSync(indexPath);

if (!indexExists) {
  console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö index.html ‡πÉ‡∏ô:', indexPath);
} else {
  console.log('‚úÖ ‡∏û‡∏ö index.html ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô:', indexPath);
}

// ‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏ü‡∏•‡πå static ‡∏à‡∏≤‡∏Å employee-dist
app.use(express.static(distPath));

// ‚úÖ ‡∏™‡πà‡∏á index.html ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ route ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á
app.get('*', (req, res) => {
  res.sendFile(indexPath);
});


// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});



// Serve static files from React build folder


